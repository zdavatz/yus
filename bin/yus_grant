#!/usr/bin/env ruby

$: << File.expand_path('../lib', File.dirname(__FILE__))

require 'drb'
require 'drb/ssl'
require 'password'
require 'rclconf'
require 'yus/session'
require 'getoptlong'

opts = []
command = :grant
date = 'until'
GetoptLong.new(
  ['--config', '-c', GetoptLong::REQUIRED_ARGUMENT],
  ['--root_name', '-r', GetoptLong::REQUIRED_ARGUMENT],
  ['--server_url', '-u', GetoptLong::REQUIRED_ARGUMENT],
  ['--yus_dir', '-d', GetoptLong::REQUIRED_ARGUMENT],
  ['--revoke', '-R', GetoptLong::NO_ARGUMENT]
).each { |key, value|
	case key
	when '--revoke'
		command = :revoke
    date = 'from'
	else
		opts.push([key, value].join('=')[2..-1])
	end
}

name, action, item, expires = ARGV

unless(action)
	puts <<-EOS
Usage: yus_grant <username> <action> [<item> [<expiry_time>]]
	EOS
  exit
end

default_dir = File.join(ENV['HOME'], '.yus')
default_config_files = [
  File.join(default_dir, 'yus.yml'),
  '/etc/yus/yus.yml',
]
defaults = {
  'config'			      => default_config_files,
  'root_name'         => 'admin',
  'server_url'        => 'drbssl://localhost:9997',
  'yus_dir'           => default_dir,
}

time = nil
if expires
  if match = /(\d{1,2})\.(\d{1,2})\.(\d{4})/.match(expires.to_s)
  time = Time.local(match[3].to_i, match[2].to_i, match[1].to_i)
  else
    puts <<-EOS
expiry_date must be in the Format: mm.dd.YYYY
    EOS
  end
end

config = RCLConf::RCLConf.new(opts, defaults)
config.load(config.config)

server = DRb::DRbObject.new(nil, config.server_url)
server.ping

session = nil
begin
  pass = Password.get("Password for #{config.root_name}: ")
  session = server.login(config.root_name, pass.to_s, 'commandline')
rescue Yus::YusError => e
  puts e.message
  retry
end

session.send(command, name, action, item, time)
puts sprintf("%sed permission to %s %s for %s %s %s", 
             command, action, item, name, date, expires)
